<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEPN GO Įrankis</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .container { max-width: 800px; margin: 1rem auto; padding: 1.5rem; background-color: #1f2937; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid transparent; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { color: #9ca3af; background-color: #374151; }
        .tab-content { display: none; margin-top: 1.5rem; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #9ca3af; font-size: 0.875rem; }
        input, select { width: 100%; padding: 0.625rem; background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.375rem; box-sizing: border-box; font-size: 0.875rem; }
        input:focus, select:focus { outline: none; border-color: #4f46e5; }
        input:disabled { background-color: #2b3341; cursor: not-allowed; }
        .grid-2-cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        button.primary-btn { width: 100%; padding: 0.75rem; background-color: #4f46e5; color: white; font-weight: 600; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; }
        button.primary-btn:hover { background-color: #4338ca; }
        button.primary-btn:disabled { background-color: #374151; cursor: not-allowed; }
        table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.75rem; font-size: 0.875rem; vertical-align: middle; border-bottom: 1px solid #4b5563; }
        th { background-color: #1f2937; font-weight: 600; white-space: nowrap; }
        td.date-cell { white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        .log-table-actions button { display: block; width: 100%; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; cursor: pointer; margin-bottom: 0.25rem; }
        .btn-edit { background-color: #3b82f6; color: white; }
        .btn-delete { background-color: #ef4444; color: white; }
        .hidden { display: none; }
        .radio-group { border: 1px solid #4b5563; border-radius: 0.375rem; overflow: hidden; }
        .radio-label { display: flex; align-items: center; justify-content: space-between; padding: 0.625rem; background-color: #374151; border-bottom: 1px solid #4b5563; cursor: pointer; }
        .radio-label span:first-child { display: flex; align-items: center; gap: 0.75rem; }
        .radio-label .token-icon { width: 24px; height: 24px; }
        .radio-label:last-child { border-bottom: none; }
        .radio-label input[type="radio"] { opacity: 0; width: 0; height: 0; position: absolute; }
        .radio-custom-dot { width: 1.25rem; height: 1.25rem; border-radius: 50%; border: 2px solid #6b7280; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .radio-custom-dot::after { content: ''; width: 0.625rem; height: 0.625rem; border-radius: 50%; background-color: #4f46e5; transform: scale(0); transition: transform 0.2s; }
        .radio-label input[type="radio"]:checked + .radio-custom-dot { border-color: #4f46e5; }
        .radio-label input[type="radio"]:checked + .radio-custom-dot::after { transform: scale(1); }
        .radio-label:hover .radio-custom-dot { border-color: #9ca3af; }
        .summary-section { margin-top: 1.5rem; padding: 1rem; background-color: #111827; border-radius: 0.5rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.875rem; align-items: center; }
        .summary-label { color: #9ca3af; }
        .summary-value { font-weight: 600; }
        .income-color { color: #34d399; }
        .expense-color { color: #f87171; }
        .btc-value { font-size: 0.75rem; color: #9ca3af; display: flex; align-items: center; gap: 0.25rem; }
        .converter-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 640px) { .converter-grid { grid-template-columns: repeat(2, 1fr); } }
        .converter-card { background-color: #374151; padding: 1rem; border-radius: 0.5rem; }
        .converter-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .converter-card-title { font-weight: 600; }
        .converter-card-update-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; background-color: #4f46e5; color: white; border-radius: 0.25rem; }
        .converter-card-price-wrapper { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem; }
        .converter-card-price { font-size: 1.25rem; font-weight: 700; }
        .price-change { font-size: 0.875rem; font-weight: 500; }
        .price-up { color: #34d399; }
        .price-down { color: #f87171; }
        .converter-card .update-time { font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; }
        .filter-section { background-color: #111827; padding: 1rem; border-radius: 0.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: end; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-6">STEPN GO Įrankis</h1>
        <nav class="flex space-x-2 sm:space-x-4 border-b border-gray-700 pb-2 mb-4">
            <button id="tab-btn-logger" class="tab-button active" data-tab="logger">Pajamų/Išlaidų Registratorius</button>
            <button id="tab-btn-converter" class="tab-button" data-tab="converter">Žetonų Kainos</button>
        </nav>
        <main>
            <div id="tab-content-logger" class="tab-content active">
                <h2 class="text-xl font-semibold mb-4">Naujas įrašas</h2>
                <form id="logForm">
                    <div class="grid-2-cols"><div class="input-group"><label for="logDate">Data</label><input type="date" id="logDate" required></div><div class="input-group"><label for="logType">Tipas</label><select id="logType" required><option value="income">Pajamos</option><option value="expense">Išlaidos</option></select></div></div>
                    <div class="input-group"><label for="logCategory">Kategorija</label><select id="logCategory" required></select></div>
                    <div id="standardFields"><div class="grid-2-cols"><div class="input-group"><label>Žetonas</label><div id="logTokenRadioGroup" class="radio-group"></div></div><div class="input-group"><label for="logTokenAmount">Suma (žetonais)</label><input type="number" id="logTokenAmount" step="any" placeholder="Kiekis"></div></div></div>
                    <div id="editFields" class="hidden grid-2-cols"><div class="input-group"><label for="editRateUsd">Kursas (USD)</label><input type="number" id="editRateUsd" step="any"></div><div class="input-group"><label for="editAmountUsd">Suma (USD)</label><input type="number" id="editAmountUsd" step="any"></div></div>
                    <div id="mintingFields" class="hidden"><div class="grid-2-cols"><div class="input-group"><label for="mintGgtAmount">GGT Suma</label><input type="number" id="mintGgtAmount" step="any" placeholder="GGT kiekis"></div><div class="input-group"><label for="mintGmtAmount">GMT Suma</label><input type="number" id="mintGmtAmount" step="any" placeholder="GMT kiekis"></div></div></div>
                    <div class="input-group mt-4"><label for="logDescription">Aprašymas (nebūtina)</label><input type="text" id="logDescription" placeholder="pvz., Parduotas 'Jogger'"></div>
                    <button id="logSubmitBtn" type="submit" class="primary-btn">Pridėti įrašą</button>
                </form>
                <hr class="my-8 border-gray-700">
                <h2 class="text-xl font-semibold mb-4">Transakcijų valdymas</h2>
                <div class="filter-section">
                    <div class="input-group"><label for="filterStartDate">Nuo</label><input type="date" id="filterStartDate"></div>
                    <div class="input-group"><label for="filterEndDate">Iki</label><input type="date" id="filterEndDate"></div>
                    <div class="input-group"><label for="filterToken">Žetonas</label><select id="filterToken"><option value="">Visi</option></select></div>
                    <div class="input-group"><label for="filterSort">Rikiuoti pagal</label><select id="filterSort"><option value="date">Data</option><option value="token_amount">Suma</option><option value="rate_usd">Kursas</option></select></div>
                    <div class="input-group"><label for="filterOrder">Tvarka</label><select id="filterOrder"><option value="desc">Mažėjančia</option><option value="asc">Didėjančia</option></select></div>
                    <button id="filterBtn" class="primary-btn h-10">Filtruoti</button>
                </div>
                <h2 class="text-xl font-semibold my-4">Transakcijų sąrašas</h2>
                <div class="overflow-x-auto"><table class="min-w-full"><thead><tr><th>Data</th><th>Tipas</th><th>Žetonas</th><th>Suma</th><th>Kursas (USD)</th><th>Suma (USD)</th><th>Aprašymas</th><th>Veiksmai</th></tr></thead><tbody id="logTableBody"></tbody></table></div>
                <div id="summaryContainer" class="summary-section"></div>
            </div>
            <div id="tab-content-converter" class="tab-content">
                <h2 class="text-xl font-semibold mb-4">Kriptovaliutų konverteris</h2><div id="converter-grid" class="converter-grid"></div>
            </div>
        </main>
    </div>

    <script>
    (function() {
        'use strict';
        const SUPABASE_URL = 'https://zojhurhwmceoqxkatvkx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvamh1cmh3bWNlb3F4a2F0dmt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjYxNDYsImV4cCI6MjA2NDc0MjE0Nn0.NFGhQc7H95U9vOaM7OVxNUgTuXSughz8ZuxaCLfbfQE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const ALL_TOKENS_CONFIG = {
            'gmt': { key: 'gmt', symbol: 'GMT (STEPN)', apiId: 'stepn', historyApiId: 'stepn' },
            'ggt': { key: 'ggt', symbol: 'GGT (STEPN GO)', apiId: 'go-game-token', historyApiId: 'ggt' },
            'gst': { key: 'gst', symbol: 'GST (SOL)', apiId: 'green-satoshi-token', historyApiId: 'green-satoshi-token' },
            'pol': { key: 'pol', symbol: 'POL (Polygon)', apiId: 'matic-network', historyApiId: 'matic-network' },
            'sol': { key: 'sol', symbol: 'SOL (Solana)', apiId: 'solana', historyApiId: 'solana' },
            'btc': { key: 'btc', symbol: 'BTC', apiId: 'bitcoin', historyApiId: 'bitcoin' },
            'usdc': { key: 'usdc', symbol: 'USDC', apiId: 'usd-coin', historyApiId: 'usd-coin', fixedPrice: 1.0 },
            'usdt': { key: 'usdt', symbol: 'USDT', apiId: 'tether', historyApiId: 'tether', fixedPrice: 1.0 },
            'bnb':  { key: 'bnb', symbol: 'BNB', apiId: 'binancecoin', historyApiId: 'binancecoin' },
            'eth':  { key: 'eth', symbol: 'ETH', apiId: 'ethereum', historyApiId: 'ethereum' }
        };
        const LOGGER_TOKEN_KEYS = ['ggt', 'gst', 'gmt', 'pol', 'sol', 'usdc', 'usdt'];
        const CATEGORIES = {
            income: { "GGT Earnings": "GGT Uždarbis", "GST Earnings": "StepN OG Uždarbis", "Sneaker Sale": "Sportbačio pardavimas", "Other": "Kita" },
            expense: { "Sneaker Purchase": "Sportbačio pirkimas", "Sneaker Burn": "Sportbačio deginimas", "Level-up": "Lygio kėlimas", "Minting": "Mintinimas", "Other": "Kita" }
        };
        let liveTokenPrices = {}, elements = {};
        
        async function init() {
            cacheDOMElements();
            bindEventListeners();
            populateDropdowns();
            await fetchLiveTokenPrices(true);
            await loadAndRenderLogTable();
            resetLogForm();
            generateConverterCards();
            updateConverterPricesUI();
        }

        function cacheDOMElements() {
            const ids = ['tab-btn-logger', 'tab-btn-converter', 'tab-content-logger', 'tab-content-converter', 'logForm', 'logDate', 'logType', 'logCategory', 'standardFields', 'logTokenRadioGroup', 'logTokenAmount', 'mintingFields', 'mintGgtAmount', 'mintGmtAmount', 'logDescription', 'logSubmitBtn', 'logTableBody', 'summaryContainer', 'converter-grid', 'filterStartDate', 'filterEndDate', 'filterToken', 'filterSort', 'filterOrder', 'filterBtn', 'editFields', 'editRateUsd', 'editAmountUsd'];
            ids.forEach(id => elements[id] = document.getElementById(id));
        }

        function bindEventListeners() {
            elements['tab-btn-logger'].addEventListener('click', () => switchTab('logger'));
            elements['tab-btn-converter'].addEventListener('click', () => switchTab('converter'));
            elements.logForm.addEventListener('submit', handleLogSubmit);
            elements.logTableBody.addEventListener('click', handleLogTableClick);
            elements['converter-grid'].addEventListener('input', handleConverterInput);
            elements['converter-grid'].addEventListener('click', handleConverterClick);
            elements.logType.addEventListener('change', updateCategoryDropdown);
            elements.logCategory.addEventListener('change', handleCategoryChange);
            elements.logTokenRadioGroup.addEventListener('change', handleTokenChange);
            elements.filterBtn.addEventListener('click', loadAndRenderLogTable);
            elements.editRateUsd.addEventListener('input', () => syncEditInputs('rate'));
            elements.editAmountUsd.addEventListener('input', () => syncEditInputs('amount'));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        }
        
        async function handleLogSubmit(event) {
            event.preventDefault();
            const editingId = elements.logForm.dataset.editingId;
            elements.logSubmitBtn.disabled = true;
            elements.logSubmitBtn.textContent = 'Apdorojama...';
            try {
                if (editingId) { await handleUpdate(editingId);
                } else { await handleCreate(); }
                await loadAndRenderLogTable();
            } catch (error) { console.error("Submit error:", error); alert(`Įvyko klaida: ${error.message}`);
            } finally { resetLogForm(); }
        }
        
        async function handleCreate() {
            const category = elements.logCategory.value, date = elements.logDate.value, type = elements.logType.value, description = elements.logDescription.value.trim();
            if (category === 'Minting') {
                const ggtAmount = parseFloat(elements.mintGgtAmount.value) || 0;
                const gmtAmount = parseFloat(elements.mintGmtAmount.value) || 0;
                if (ggtAmount > 0) await createSingleLogEntry({ date, type, tokenKey: 'ggt', tokenAmount: ggtAmount, category, description });
                if (gmtAmount > 0) await createSingleLogEntry({ date, type, tokenKey: 'gmt', tokenAmount: gmtAmount, category, description });
            } else {
                const selectedTokenRadio = document.querySelector('input[name="logToken"]:checked');
                if (!selectedTokenRadio) throw new Error("Prašome pasirinkti žetoną.");
                const tokenAmount = parseFloat(elements.logTokenAmount.value);
                if (isNaN(tokenAmount) || tokenAmount <= 0) throw new Error("Prašome įvesti teigiamą sumą.");
                await createSingleLogEntry({ date, type, tokenKey: selectedTokenRadio.value, tokenAmount, category, description });
            }
        }
        
        async function handleUpdate(id) {
            const newDate = elements.logDate.value;
            const newAmount = parseFloat(elements.logTokenAmount.value);
            const newToken = document.querySelector('input[name="logToken"]:checked').value;
            const oldEntry = JSON.parse(elements.logForm.dataset.oldEntry);
            
            let rate_usd = parseFloat(elements.editRateUsd.value);
            if (isNaN(rate_usd)) throw new Error("Neteisingas kursas.");
            if (newDate !== oldEntry.date || newToken !== oldEntry.token) {
                 elements.logSubmitBtn.textContent = `Gaunamas ${newToken.toUpperCase()} kursas...`;
                 rate_usd = await getPriceForDate(newToken, newDate);
            }
            
            const record = { date: newDate, type: elements.logType.value, token: newToken, token_amount: newAmount, category: elements.logCategory.value, description: elements.logDescription.value.trim(), rate_usd };
            const { error } = await supabase.from('transactions').update(record).eq('id', id);
            if (error) throw error;
        }

        async function createSingleLogEntry(entryData) {
             elements.logSubmitBtn.textContent = `Gaunamas ${entryData.tokenKey.toUpperCase()} kursas...`;
             const rate_usd = await getPriceForDate(entryData.tokenKey, entryData.date);
             const record = { date: entryData.date, type: entryData.type, token: entryData.tokenKey, token_amount: entryData.tokenAmount, category: entryData.category, description: entryData.description, rate_usd };
             const { error } = await supabase.from('transactions').insert([record]).select();
             if (error) throw error;
        }
        
        async function handleLogTableClick(event) {
            const target = event.target;
            const row = target.closest('tr');
            if (!row || !row.dataset.id) return;
            const entryId = parseInt(row.dataset.id);
            if (target.matches('.btn-delete')) {
                if (confirm('Ar tikrai norite ištrinti šį įrašą?')) {
                    const { error } = await supabase.from('transactions').delete().eq('id', entryId);
                    if(error) alert(`Klaida trinant: ${error.message}`);
                    else await loadAndRenderLogTable();
                }
            } else if (target.matches('.btn-edit')) {
                const { data, error } = await supabase.from('transactions').select().eq('id', entryId).single();
                if (error) { alert(`Klaida gaunant įrašą: ${error.message}`); return; }
                startEditEntry(data);
            }
        }

        function startEditEntry(entry) {
            if (!entry) return;
            if (entry.category === 'Minting') { alert("Mintinimo įrašų redagavimas nepalaikomas. Ištrinkite ir sukurkite naują."); return; }
            resetLogForm(); 
            elements.logForm.dataset.editingId = entry.id;
            elements.logForm.dataset.oldEntry = JSON.stringify(entry);
            elements.logDate.value = entry.date;
            elements.logType.value = entry.type;
            document.querySelector(`input[name="logToken"][value="${entry.token}"]`).checked = true;
            updateCategoryDropdown(); 
            elements.logCategory.value = entry.category;
            handleCategoryChange(); 
            elements.logTokenAmount.value = entry.token_amount;
            elements.logDescription.value = entry.description;
            elements.editFields.classList.remove('hidden');
            elements.editRateUsd.value = entry.rate_usd.toFixed(5);
            elements.editAmountUsd.value = (entry.token_amount * entry.rate_usd).toFixed(2);
            elements.logSubmitBtn.textContent = 'Atnaujinti įrašą';
            elements.logSubmitBtn.style.backgroundColor = '#2563eb';
            elements.logSubmitBtn.disabled = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetLogForm() {
            elements.logForm.reset();
            delete elements.logForm.dataset.editingId;
            delete elements.logForm.dataset.oldEntry;
            elements.editFields.classList.add('hidden');
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            elements.logDate.value = today.toISOString().split('T')[0];
            updateCategoryDropdown();
            handleCategoryChange();
            if(document.querySelector('input[name="logToken"]')) { document.querySelector('input[name="logToken"]').checked = true; }
            elements.logSubmitBtn.textContent = 'Pridėti įrašą';
            elements.logSubmitBtn.style.backgroundColor = '';
            elements.logSubmitBtn.disabled = false;
        }

        function syncEditInputs(source) {
            const rate = parseFloat(elements.editRateUsd.value);
            const total = parseFloat(elements.editAmountUsd.value);
            const amount = parseFloat(elements.logTokenAmount.value);
            if (source === 'rate' && !isNaN(rate) && !isNaN(amount)) {
                elements.editAmountUsd.value = (amount * rate).toFixed(2);
            } else if (source === 'amount' && !isNaN(total) && !isNaN(amount) && amount > 0) {
                elements.editRateUsd.value = (total / amount).toFixed(8);
            }
        }

        function populateDropdowns() {
            elements.logTokenRadioGroup.innerHTML = LOGGER_TOKEN_KEYS.map((key, index) => {
                const token = ALL_TOKENS_CONFIG[key];
                return `<label class="radio-label"><span>${token.symbol.split(' ')[0]}</span><input type="radio" name="logToken" value="${key}" ${index === 0 ? 'checked' : ''}><span class="radio-custom-dot"></span></label>`;
            }).join('');
            elements.filterToken.innerHTML = '<option value="">Visi</option>' + LOGGER_TOKEN_KEYS.map(key => `<option value="${key}">${ALL_TOKENS_CONFIG[key].symbol}</option>`).join('');
        }

        function updateCategoryDropdown() {
            const type = elements.logType.value;
            const selectedTokenRadio = document.querySelector('input[name="logToken"]:checked');
            const selectedToken = selectedTokenRadio ? selectedTokenRadio.value : LOGGER_TOKEN_KEYS[0];
            let categories = CATEGORIES[type] || {};
            if (type === 'income') {
                categories = Object.fromEntries(Object.entries(categories).filter(([key]) => {
                    if (key === 'GGT Earnings') return selectedToken === 'ggt';
                    if (key === 'GST Earnings') return selectedToken === 'gst';
                    if (key === 'Sneaker Sale') return selectedToken === 'gmt';
                    return true;
                }));
            }
            const currentCategory = elements.logCategory.value;
            elements.logCategory.innerHTML = Object.entries(categories).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            if (categories[currentCategory]) { elements.logCategory.value = currentCategory; }
            handleCategoryChange();
        }

        function handleCategoryChange() {
            const category = elements.logCategory.value;
            const isMinting = category === 'Minting';
            elements.mintingFields.classList.toggle('hidden', !isMinting);
            if (!elements.logForm.dataset.editingId) {
                elements.standardFields.classList.toggle('hidden', isMinting);
            }
        }
        
        function handleTokenChange() { updateCategoryDropdown(); }
        
        function generateConverterCards() {
            const allTokens = [ { key: 'usd', symbol: 'USD', apiId: 'usd', fixedPrice: 1.0 }, ...Object.values(ALL_TOKENS_CONFIG) ].filter((v,i,a)=>a.findIndex(t=>(t.apiId === v.apiId))===i); 
            let html = '';
            allTokens.forEach(token => { html += `<div class="converter-card" id="card-${token.apiId}"><div class="converter-card-header"><span class="converter-card-title">${token.symbol}</span><button class="converter-card-update-btn" data-api-id="${token.apiId}">Atnaujinti</button></div><div class="converter-card-price-wrapper"><div class="converter-card-price" id="price-${token.apiId}">$0.00000</div><div class="price-change" id="change-${token.apiId}"></div></div><div class="input-group"><label for="amount-${token.apiId}" class="text-xs">Kiekis:</label><input type="number" id="amount-${token.apiId}" data-api-id="${token.apiId}" class="converter-amount-input" placeholder="0.00"></div><div class="input-group"><label for="value-${token.apiId}" class="text-xs">Vertė USD:</label><input type="number" id="value-${token.apiId}" class="converter-value-input" placeholder="0.00"></div><div class="update-time" id="time-${token.apiId}"></div></div>`; });
            elements['converter-grid'].innerHTML = html;
        }

        function handleConverterInput(event) {
            const input = event.target; const value = parseFloat(input.value);
            if(isNaN(value)) { document.querySelectorAll('.converter-amount-input, .converter-value-input').forEach(i => { if(i !== input) i.value = ''; }); return; }
            let usdValue;
            if(input.classList.contains('converter-amount-input')) {
                const apiId = input.dataset.apiId; const price = liveTokenPrices[apiId]?.price || 0; usdValue = value * price;
            } else { usdValue = value; }
            document.querySelectorAll('.converter-card').forEach(card => {
                const cardApiId = card.id.replace('card-', ''); const price = liveTokenPrices[cardApiId]?.price || 0;
                const valueInput = card.querySelector('.converter-value-input'); const amountInput = card.querySelector('.converter-amount-input');
                if (input !== valueInput) valueInput.value = usdValue.toFixed(2);
                if (input !== amountInput && price > 0) amountInput.value = (usdValue / price).toFixed(6);
            });
        }
        
        async function handleConverterClick(event) {
            if (event.target.classList.contains('converter-card-update-btn')) {
                const apiId = event.target.dataset.apiId;
                await fetchLiveTokenPrices(false, apiId);
            }
        }
        
        async function getPriceForDate(tokenKey, dateString) {
            const config = ALL_TOKENS_CONFIG[tokenKey]; if (!config) throw new Error("Nežinomas žetonas"); if (config.fixedPrice) return config.fixedPrice;
            const today = new Date(); today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            if (dateString >= today.toISOString().split('T')[0] && liveTokenPrices[config.apiId]) { return liveTokenPrices[config.apiId].price; }
            const [year, month, day] = dateString.split('-'); const apiDate = `${day}-${month}-${year}`;
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${config.historyApiId}/history?date=${apiDate}`);
                if (!response.ok) throw new Error(`API klaida (${response.status})`); 
                const data = await response.json();
                if (data.market_data?.current_price?.usd) return data.market_data.current_price.usd;
                console.warn(`Istorinė kaina nerasta ${config.symbol} datai ${dateString}. Bandoma gauti dabartinę kainą.`);
                alert(`Dėmesio: Nepavyko gauti istorinio ${config.symbol.toUpperCase()} kurso. Įrašui panaudotas dabartinis kursas.`);
                if (Object.keys(liveTokenPrices).length === 0) await fetchLiveTokenPrices(true);
                const currentPrice = liveTokenPrices[config.apiId]?.price;
                if (currentPrice) return currentPrice;
                throw new Error(`Neįmanoma gauti kainos ${config.symbol} žetonui.`);
            } catch (error) { console.error("Klaida gaunant istorinę kainą:", error); throw error; }
        }

        async function fetchLiveTokenPrices(fetchAll = false, singleApiId = null) {
            let tokenApiIds;
            if(fetchAll) { tokenApiIds = [...new Set(Object.values(ALL_TOKENS_CONFIG).map(t => t.apiId).filter(id => id && id !== 'usd'))];
            } else if (singleApiId) { tokenApiIds = [singleApiId]; } else { return; }
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${tokenApiIds.join(',')}&vs_currencies=usd&include_24hr_change=true`);
                if (!response.ok) throw new Error(`API klaida: ${response.statusText}`);
                const data = await response.json();
                liveTokenPrices['usd'] = { price: 1, change: 0 };
                for (const apiId in data) { liveTokenPrices[apiId] = { price: data[apiId].usd, change: data[apiId].usd_24h_change || 0 }; }
                updateConverterPricesUI();
            } catch (error) { console.error("Klaida gaunant realaus laiko kainas:", error); }
        }

        async function loadAndRenderLogTable() {
            let query = supabase.from('transactions').select('*');
            if (elements.filterStartDate.value) query = query.gte('date', elements.filterStartDate.value);
            if (elements.filterEndDate.value) query = query.lte('date', elements.filterEndDate.value);
            if (elements.filterToken.value) query = query.eq('token', elements.filterToken.value);
            const sortOrder = elements.filterOrder.value === 'asc';
            const sortBy = elements.filterSort.value;
            query = query.order(sortBy, { ascending: sortOrder }).order('id', { ascending: false });
            const { data, error } = await query;
            if (error) { console.error('Klaida gaunant duomenis:', error); return; }
            renderLogTable(data);
        }

        function renderLogTable(data) {
            elements.logTableBody.innerHTML = ''; let totalIncomeUSD = 0, totalExpenseUSD = 0; const tokenBalances = {};
            data.forEach(entry => {
                const amount_usd = entry.token_amount * entry.rate_usd;
                const isIncome = entry.type === 'income';
                if (isIncome) totalIncomeUSD += amount_usd; else totalExpenseUSD += amount_usd;
                if (!tokenBalances[entry.token]) tokenBalances[entry.token] = 0;
                tokenBalances[entry.token] += isIncome ? entry.token_amount : -entry.token_amount;
                const row = document.createElement('tr'); row.dataset.id = entry.id;
                row.innerHTML = `<td>${entry.date}</td><td style="font-size: 1.25rem; text-align: center;" class="${isIncome ? 'income-color' : 'expense-color'}">${isIncome ? '▼' : '▲'}</td><td>${entry.token.toUpperCase()}</td><td>${(entry.token_amount || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}</td><td>$${(entry.rate_usd || 0).toFixed(5)}</td><td>$${amount_usd.toFixed(2)}</td><td>${entry.description || ''}</td><td class="log-table-actions"><button class="btn-edit">Taisyti</button><button class="btn-delete">Trinti</button></td>`;
                elements.logTableBody.appendChild(row);
            });
            renderSummary(totalIncomeUSD, totalExpenseUSD, tokenBalances);
        }
        
        function renderSummary(income, expense, tokenBalances) {
            const balance = income - expense;
            const btcPrice = liveTokenPrices['bitcoin']?.price;
            let btcValueHTML = '';
            if (btcPrice > 0) {
                const btcValue = balance / btcPrice;
                btcValueHTML = `<div class="summary-row"><span class="summary-label btc-value"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/></svg> BTC Atitikmuo:</span><span class="summary-value btc-value">${btcValue.toFixed(8)} BTC</span></div>`;
            }

            let tokenBalancesHTML = '<hr class="my-4 border-gray-700"><h3 class="text-lg font-semibold mb-2">Žetonų Balansai</h3>';
            Object.keys(tokenBalances).sort().forEach(token => { const amount = tokenBalances[token]; tokenBalancesHTML += `<div class="summary-row"><span class="summary-label">${token.toUpperCase()} Balansas:</span><span class="summary-value ${amount >= 0 ? 'income-color' : 'expense-color'}">${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4})}</span></div>`; });
            
            elements.summaryContainer.innerHTML = `<h3 class="text-lg font-semibold mb-2">Bendra suvestinė (pagal filtrus)</h3><div class="summary-row"><span class="summary-label">Viso Pajamų (USD):</span><span class="summary-value income-color">$${income.toFixed(2)}</span></div><div class="summary-row"><span class="summary-label">Viso Išlaidų (USD):</span><span class="summary-value expense-color">$${expense.toFixed(2)}</span></div><div class="summary-row text-lg border-t border-gray-700 mt-2 pt-2"><strong class="summary-label">Grynasis Balansas (USD):</strong><strong class="summary-value ${balance >= 0 ? 'income-color' : 'expense-color'}">$${balance.toFixed(2)}</strong></div>${btcValueHTML}${tokenBalancesHTML}`;
        }

        // ===================================================
        // PATAISYMAS PRASIDEDA ČIA
        // ===================================================
        function updateConverterPricesUI() {
             document.querySelectorAll('.converter-card').forEach(card => {
                const apiId = card.id.replace('card-', '');
                const priceData = liveTokenPrices[apiId];
                const priceEl = card.querySelector(`#price-${apiId}`);
                const changeEl = card.querySelector(`#change-${apiId}`);

                if (priceData && typeof priceData.price !== 'undefined') {
                    priceEl.textContent = `$${priceData.price.toFixed(5)}`;
                    
                    const change = priceData.change || 0;
                    
                    changeEl.classList.remove('price-up', 'price-down');

                    if (change > 0) {
                        changeEl.textContent = `▲ +${change.toFixed(2)}%`;
                        changeEl.classList.add('price-up');
                    } else if (change < 0) {
                        changeEl.textContent = `▼ ${change.toFixed(2)}%`;
                        changeEl.classList.add('price-down');
                    } else {
                        changeEl.textContent = `${change.toFixed(2)}%`;
                    }
                } else { 
                    priceEl.textContent = 'N/A'; 
                    changeEl.textContent = ''; 
                }
                card.querySelector(`#time-${apiId}`).textContent = `Atnaujinta: ${new Date().toLocaleTimeString('lt-LT')}`;
             });
        }
        // ===================================================
        // PATAISYMO PABAIGA
        // ===================================================
        
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
